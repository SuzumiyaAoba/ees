name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Run type checking
      run: npm run type-check

    - name: Run tests
      run: |
        export NODE_ENV=test
        npm test

    - name: Build application
      run: npm run build

  # Temporarily disabled due to npmDepsHash mismatch
  # nix-build:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #   - name: Install Nix
  #     uses: cachix/install-nix-action@v27
  #     with:
  #       github_access_token: ${{ secrets.GITHUB_TOKEN }}
  #       nix_path: nixpkgs=channel:nixos-23.11
  #   - name: Check Nix flake
  #     run: nix flake check --allow-import-from-derivation
  #   - name: Build Nix package
  #     run: nix build .#ees --print-build-logs
  #   - name: Test Nix package build
  #     run: |
  #       echo 'Testing Nix package...'
  #       ls -la result/
  #       file result/bin/ees

  format-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check code formatting
      run: |
        echo 'Checking code formatting...'
        npm run format

        # Check if there are any changes after formatting
        if ! git diff --exit-code; then
          echo 'Code is not properly formatted. Please run npm run format'
          exit 1
        fi

        echo 'Code formatting is correct'

  security:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level=high